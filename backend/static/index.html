<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneScape Lite Advisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
        }

        header > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        header > div > div {
            flex: 1;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .profile-section h2 {
            margin-bottom: 20px;
            color: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 10px;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-item {
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .profile-item label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .profile-item .value {
            color: #333;
            font-size: 1rem;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .skill-badge {
            background: #4a5568;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.875rem;
            min-width: 60px;
            text-align: center;
            display: inline-block;
            font-weight: 500;
        }

        .button-group {
            text-align: center;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 0.9375rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #4a5568;
            color: white;
            transition: background 0.2s;
            height: 40px;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:hover:not(:disabled) {
            background: #2d3748;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .advice-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .advice-section h2 {
            margin-bottom: 20px;
            color: #2d3748;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 10px;
        }

        .advice-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .advice-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .beginner-card {
            background: white;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .advice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .advice-card.selected {
            border: 2px solid #4a5568 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }

        .advice-card h3 {
            color: #2d3748;
            margin-bottom: 12px;
            font-size: 1.3rem;
        }

        .why-now {
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }

        .why-now strong {
            color: #333;
        }

        .steps {
            margin-top: 15px;
        }

        .steps strong {
            color: #333;
            display: block;
            margin-bottom: 10px;
        }

        .steps ol {
            margin-left: 20px;
        }

        .steps li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: #444;
        }

        .placeholder {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            background: #c6f6d5;
            border-radius: 6px;
            color: #22543d;
            text-align: center;
            display: none;
        }

        .message.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .message.show {
            display: block;
        }

        .loading {
            text-align: center;
            color: #4a5568;
            padding: 20px;
        }

        .build-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .build-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .build-card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .build-section {
            margin-bottom: 15px;
        }

        .gear-option-pill {
            padding: 6px 14px;
            border: 2px solid #718096;
            background: #f7fafc;
            color: #2d3748;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-transform: capitalize;
            font-weight: 500;
        }

        .gear-option-pill:hover {
            border-color: #4a5568;
            background: #edf2f7;
        }

        .gear-option-pill.active {
            background: #2d3748;
            color: white;
            border-color: #2d3748;
        }

        .build-section strong {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .build-section ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .build-section li {
            margin-bottom: 5px;
            color: #444;
            line-height: 1.5;
        }

        .strategy-card {
            background: #ffffff;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 25px;
            transition: transform 0.2s, box-shadow 0.2s;
            color: #2d3748;
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .strategy-card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .strategy-why {
            margin-bottom: 20px;
            line-height: 1.7;
            font-size: 1.05rem;
            color: #4a5568;
        }

        .strategy-unlocks {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .strategy-unlocks h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .strategy-unlocks ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .strategy-unlocks li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .strategy-actions {
            margin-bottom: 20px;
        }

        .strategy-actions h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .strategy-actions ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .strategy-actions li {
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .strategy-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .strategy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            transition: all 0.2s;
            height: 40px;
            min-height: 40px;
        }

        .strategy-btn:hover {
            background: #2d3748;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .setup-card {
            background: white;
            border: 2px solid #4a5568;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .setup-option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-option:hover {
            border-color: #4a5568;
            background: #edf2f7;
            transform: translateY(-1px);
        }

        .setup-option.selected {
            border-color: #4a5568;
            background: #e2e8f0;
        }

        .setup-option-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .setup-option-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .setup-progress {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .details-link {
            color: #4a5568;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 8px;
        }

        .details-link:hover {
            color: #2d3748;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: #2d3748;
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-steps {
            margin-bottom: 20px;
        }

        .modal-steps h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .modal-steps ol {
            margin-left: 20px;
        }

        .modal-steps li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .modal-sources {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
        }

        .modal-sources h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .modal-sources ul {
            margin-left: 20px;
        }

        .modal-sources li {
            margin-bottom: 5px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h1>RuneScape Lite Advisor</h1>
                    <p>Get personalized advice for your RuneScape journey</p>
                </div>
                <button 
                    id="profile-setup-btn"
                    onclick="openSetupForEditing()"
                    title="Edit Player Setup"
                >
                    ⚙️ Profile
                </button>
            </div>
        </header>

        <section class="profile-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="margin: 0;">Your Profile</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="font-weight: 600; color: #555; font-size: 0.9rem;">Membership:</label>
                    <div style="display: flex; background: #e2e8f0; border-radius: 20px; padding: 2px; gap: 2px;">
                        <button 
                            id="membership-f2p-btn"
                            onclick="setMembership('f2p')"
                            style="padding: 6px 16px; border: none; border-radius: 18px; background: transparent; color: #4a5568; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; font-weight: 500; height: auto; min-height: auto;"
                        >F2P</button>
                        <button 
                            id="membership-p2p-btn"
                            onclick="setMembership('p2p')"
                            style="padding: 6px 16px; border: none; border-radius: 18px; background: transparent; color: #4a5568; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; font-weight: 500; height: auto; min-height: auto;"
                        >Members</button>
                    </div>
                </div>
            </div>
            <div id="membership-message" style="font-size: 0.85rem; color: #e53e3e; min-height: 20px; margin-bottom: 10px;"></div>
            <div id="profile-content">
                <div class="loading">Loading profile...</div>
            </div>
        </section>

        <section class="profile-section">
            <h2>Import from Hiscores</h2>
            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label for="player-name" style="display: block; font-weight: 600; color: #555; margin-bottom: 8px;">Player Name</label>
                    <input 
                        type="text" 
                        id="player-name" 
                        placeholder="Enter RuneScape username"
                        style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;"
                        onkeypress="if(event.key === 'Enter') importHiscores()"
                    />
                </div>
                <button id="import-btn" onclick="importHiscores()" style="white-space: nowrap;">Import from Hiscores</button>
            </div>
            <div id="import-message" class="message"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                <button id="get-advice-btn" onclick="getAdvice()">Get Advice</button>
            </div>
            <div id="message" class="message" style="margin-top: 10px;"></div>
        </section>

        <section id="setup-section" class="profile-section" style="display: none;">
            <h2>Player Setup</h2>
            <div id="setup-content">
                <!-- Setup cards will be rendered here -->
            </div>
        </section>


        <section class="profile-section" id="recommendations-section" style="display: none;">
            <h2>Recommendations</h2>
            <div id="recommendations-content">
                <p class="placeholder">Loading recommendations...</p>
            </div>
        </section>

        <section class="profile-section" id="next-strategy-section">
            <h2>Next Action</h2>
            <div id="next-strategy-content">
                <p class="placeholder">Click Get Advice to generate your next action.</p>
            </div>
        </section>

    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-steps" class="modal-steps"></div>
            <div id="modal-sources" class="modal-sources"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        // Setup state
        let setupState = {
            style: "",
            priority: "",
            effort: ""
        };
        let currentSetupStep = 0;
        const SETUP_STORAGE_KEY = "rsla_player_profile";

        // Load setup from localStorage
        function loadSetupFromStorage() {
            try {
                const stored = localStorage.getItem(SETUP_STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed.style || parsed.priority || parsed.effort) {
                        return {
                            style: parsed.style || "",
                            priority: parsed.priority || "",
                            effort: parsed.effort || ""
                        };
                    }
                }
            } catch (error) {
                console.error('Failed to load setup from localStorage:', error);
            }
            return { style: "", priority: "", effort: "" };
        }

        // Save setup to localStorage
        function saveSetupToStorage() {
            try {
                localStorage.setItem(SETUP_STORAGE_KEY, JSON.stringify(setupState));
            } catch (error) {
                console.error('Failed to save setup to localStorage:', error);
            }
        }

        // Clear setup from localStorage
        function clearSetupStorage() {
            try {
                localStorage.removeItem(SETUP_STORAGE_KEY);
            } catch (error) {
                console.error('Failed to clear setup from localStorage:', error);
            }
        }

        // Load profile and check setup on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await checkSetup();
        });

        async function checkSetup() {
            // Load from localStorage first
            const localSetup = loadSetupFromStorage();
            
            try {
                const response = await fetch(`${API_URL}/setup`);
                if (response.ok) {
                    const serverSetup = await response.json();
                    // Merge: prefer localStorage if it has values, otherwise use server
                    setupState = {
                        style: localSetup.style || serverSetup.style || "",
                        priority: localSetup.priority || serverSetup.priority || "",
                        effort: localSetup.effort || serverSetup.effort || ""
                    };
                    
                    // Save merged state to localStorage
                    saveSetupToStorage();
                } else {
                    // Use localStorage if server fails
                    setupState = localSetup;
                }
            } catch (error) {
                console.error('Failed to load setup from server:', error);
                // Use localStorage if server fails
                setupState = localSetup;
            }
            
            // Check if setup is complete
            if (setupState.style && setupState.priority && setupState.effort) {
                // Setup complete - hide setup
                document.getElementById('setup-section').style.display = 'none';
            } else {
                // Setup incomplete - show setup flow
                currentSetupStep = setupState.style ? (setupState.priority ? 2 : 1) : 0;
                displaySetupCard();
                document.getElementById('setup-section').style.display = 'block';
            }
        }


        function continueWithSetup() {
            // Hide setup section
            document.getElementById('setup-section').style.display = 'none';
        }

        function openSetupForEditing() {
            // Open setup flow for editing without resetting progress
            // Determine which step to show based on current state
            currentSetupStep = setupState.style ? (setupState.priority ? 2 : 1) : 0;
            displaySetupCard();
            document.getElementById('setup-section').style.display = 'block';
            
            // Scroll to setup section
            document.getElementById('setup-section').scrollIntoView({ behavior: 'smooth' });
        }

        function resetSetup() {
            // Clear localStorage and reset state
            clearSetupStorage();
            setupState = { style: "", priority: "", effort: "" };
            currentSetupStep = 0;
            
            // Clear server state
            fetch(`${API_URL}/setup`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(setupState),
            }).catch(error => {
                console.error('Failed to reset setup on server:', error);
            });
            
            // Show setup flow from beginning
            displaySetupCard();
        }

        function displaySetupCard() {
            const setupContent = document.getElementById('setup-content');
            const setupSection = document.getElementById('setup-section');
            
            if (!setupSection) return;
            
            const steps = [
                {
                    title: "Combat Style",
                    options: [
                        { value: "melee", label: "Melee", desc: "Close-range combat with swords, scimitars, and melee weapons" },
                        { value: "ranged", label: "Ranged", desc: "Long-range combat with bows, crossbows, and throwing weapons" },
                        { value: "mage", label: "Mage", desc: "Magic combat with spells, staves, and magical attacks" }
                    ],
                    field: "style"
                },
                {
                    title: "Priority",
                    options: [
                        { value: "fast", label: "Fast progress", desc: "Prioritize speed and efficiency over cost or safety" },
                        { value: "safe", label: "Safe & steady", desc: "Focus on safe methods and steady progression" },
                        { value: "cheap", label: "Cheap/low-GP", desc: "Minimize costs and use budget-friendly methods" }
                    ],
                    field: "priority"
                },
                {
                    title: "Effort",
                    options: [
                        { value: "afk", label: "AFK-ish", desc: "Prefer methods that require minimal attention" },
                        { value: "normal", label: "Normal", desc: "Standard gameplay with moderate attention required" },
                        { value: "sweaty", label: "Sweaty", desc: "Maximum efficiency with high attention and effort" }
                    ],
                    field: "effort"
                }
            ];

            if (currentSetupStep >= steps.length) {
                // Setup complete, save and hide
                saveSetupAndContinue();
                return;
            }

            const step = steps[currentSetupStep];
            const selectedValue = setupState[step.field];

            setupContent.innerHTML = `
                <div class="setup-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="setup-progress">Setup ${currentSetupStep + 1}/3</div>
                        <a href="#" onclick="resetSetup(); return false;" style="color: #4a5568; text-decoration: none; font-size: 0.9rem;">Reset setup</a>
                    </div>
                    <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">${step.title}</h3>
                    <div>
                        ${step.options.map(option => `
                            <div 
                                class="setup-option ${selectedValue === option.value ? 'selected' : ''}"
                                onclick="selectSetupOption('${step.field}', '${option.value}')"
                            >
                                <div class="setup-option-title">${option.label}</div>
                                <div class="setup-option-desc">${option.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                        <button 
                            onclick="previousSetupStep()" 
                            ${currentSetupStep === 0 ? 'disabled' : ''}
                            style="padding: 10px 20px; background: ${currentSetupStep === 0 ? '#ccc' : '#4a5568'}; color: white; border: none; border-radius: 6px; cursor: ${currentSetupStep === 0 ? 'not-allowed' : 'pointer'}; font-weight: 600; flex: 1; height: 40px; min-height: 40px;"
                        >
                            ← Back
                        </button>
                        <button 
                            onclick="nextSetupStep()" 
                            ${!selectedValue ? 'disabled' : ''}
                            style="padding: 10px 20px; background: ${!selectedValue ? '#ccc' : '#4a5568'}; color: white; border: none; border-radius: 6px; cursor: ${!selectedValue ? 'not-allowed' : 'pointer'}; font-weight: 600; flex: 1; height: 40px; min-height: 40px;"
                        >
                            Next →
                        </button>
                    </div>
                </div>
            `;
        }

        async function selectSetupOption(field, value) {
            setupState[field] = value;
            
            // Save to localStorage immediately
            saveSetupToStorage();
            
            displaySetupCard();
            
            // Auto-save to server on selection
            try {
                await fetch(`${API_URL}/setup`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(setupState),
                });
            } catch (error) {
                console.error('Failed to save setup to server:', error);
            }
        }

        function nextSetupStep() {
            const currentValue = currentSetupStep === 0 ? setupState.style : 
                                 currentSetupStep === 1 ? setupState.priority : 
                                 setupState.effort;
            
            if (currentValue) {
                currentSetupStep++;
                displaySetupCard();
            }
        }

        function previousSetupStep() {
            if (currentSetupStep > 0) {
                currentSetupStep--;
                displaySetupCard();
            }
        }

        async function saveSetupAndContinue() {
            // Save to localStorage
            saveSetupToStorage();
            
            try {
                await fetch(`${API_URL}/setup`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(setupState),
                });
            } catch (error) {
                console.error('Failed to save setup to server:', error);
            }
            
            // Check if setup is now complete
            if (setupState.style && setupState.priority && setupState.effort) {
                // Setup complete - hide setup
                document.getElementById('setup-section').style.display = 'none';
            } else {
                // Still incomplete, just update the card
                displaySetupCard();
            }
        }

        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/profile`);
                
                if (!response.ok) {
                    // Handle non-200 responses gracefully
                    const errorText = await response.text();
                    console.error('Failed to load profile:', response.status, errorText);
                    document.getElementById('profile-content').innerHTML = 
                        '<div class="message error show">Failed to load profile</div>';
                    return;
                }
                
                const profile = await response.json();
                displayProfile(profile);
            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profile-content').innerHTML = 
                    '<div class="message error show">Failed to load profile</div>';
            }
        }



        function displayProfile(profile) {
            const content = document.getElementById('profile-content');
            
            // Update player name input if it exists
            const playerNameInput = document.getElementById('player-name');
            if (playerNameInput) {
                playerNameInput.value = profile.player_name || '';
            }
            
            // Update membership toggle if it exists
            updateMembershipToggle(profile.membership || 'f2p');
            
            const skillsList = Object.entries(profile.skills || {})
                .map(([skill, level]) => `<span class="skill-badge">${skill}: ${level}</span>`)
                .join('');

            content.innerHTML = `
                <div class="profile-info">
                    <div class="profile-item">
                        <label>Player Name</label>
                        <div class="value">${profile.player_name || 'Not set'}</div>
                    </div>
                    <div class="profile-item">
                        <label>Game Mode</label>
                        <div class="value">${profile.game_mode || 'main'}</div>
                    </div>
                    <div class="profile-item">
                        <label>Membership</label>
                        <div class="value">${profile.membership === 'p2p' ? 'Members' : 'Free-to-Play'}</div>
                    </div>
                    <div class="profile-item">
                        <label>Playtime</label>
                        <div class="value">${profile.playtime_minutes || 0} minutes</div>
                    </div>
                    <div class="profile-item">
                        <label>Goals</label>
                        <div class="value">${profile.goals && profile.goals.length > 0 ? profile.goals.join(', ') : 'None'}</div>
                    </div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; color: #555; margin-bottom: 10px;">Skills</label>
                    <div class="skills-list">${skillsList || 'No skills set'}</div>
                </div>
            `;
        }

        function updateMembershipToggle(membership) {
            const f2pBtn = document.getElementById('membership-f2p-btn');
            const p2pBtn = document.getElementById('membership-p2p-btn');
            if (!f2pBtn || !p2pBtn) return;

            if (membership === 'p2p') {
                f2pBtn.style.background = 'transparent';
                f2pBtn.style.color = '#555';
                p2pBtn.style.background = '#4a5568';
                p2pBtn.style.color = 'white';
            } else {
                f2pBtn.style.background = '#4a5568';
                f2pBtn.style.color = 'white';
                p2pBtn.style.background = 'transparent';
                p2pBtn.style.color = '#555';
            }
        }

        async function setMembership(membership) {
            const membershipMessage = document.getElementById('membership-message');
            membershipMessage.textContent = '';

            // Update toggle immediately for better UX
            updateMembershipToggle(membership);

            try {
                // Get current profile
                const profileResponse = await fetch(`${API_URL}/profile`);
                if (!profileResponse.ok) {
                    throw new Error('Failed to load profile');
                }
                const profile = await profileResponse.json();

                // Update membership
                profile.membership = membership;

                // Save profile
                const saveResponse = await fetch(`${API_URL}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(profile),
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    throw new Error(errorText || 'Failed to save membership');
                }

                // Refresh profile display
                await loadProfile();
            } catch (error) {
                console.error('Failed to save membership:', error);
                membershipMessage.textContent = error.message || 'Error saving membership';
                // Revert toggle to previous state
                const profileResponse = await fetch(`${API_URL}/profile`);
                if (profileResponse.ok) {
                    const profile = await profileResponse.json();
                    updateMembershipToggle(profile.membership || 'f2p');
                }
            }
        }

        async function importHiscores() {
            const playerNameInput = document.getElementById('player-name');
            const importBtn = document.getElementById('import-btn');
            const importMessage = document.getElementById('import-message');
            const playerName = playerNameInput.value.trim();

            if (!playerName) {
                importMessage.className = 'message error show';
                importMessage.textContent = 'Please enter a player name';
                return;
            }

            importBtn.disabled = true;
            importMessage.className = 'message';
            importMessage.textContent = 'Importing hiscores...';

            try {
                const response = await fetch(`${API_URL}/import/hiscores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ player_name: playerName }),
                });

                if (!response.ok) {
                    // Read response.text() when response is not ok
                    const errorText = await response.text();
                    console.error('Hiscores import failed:', response.status, errorText);
                    importMessage.className = 'message error show';
                    importMessage.textContent = errorText || 'Failed to import hiscores';
                    return;
                }

                // Only call response.json() when response.ok === true
                const data = await response.json();
                importMessage.className = 'message show';
                importMessage.textContent = data.message || 'Hiscores imported successfully!';

                // Refresh profile and advice
                await loadProfile();
                await getAdvice();
            } catch (error) {
                console.error('Failed to import hiscores:', error);
                importMessage.className = 'message error show';
                importMessage.textContent = error.message || 'Error importing hiscores';
            } finally {
                importBtn.disabled = false;
            }
        }

        let beginnerCards = [];
        let currentCardIndex = 0;
        let advice = null;
        let isFetchingAdvice = false;
        let selectedPathId = null;

        async function getAdvice() {
            // Prevent duplicate fetches
            if (isFetchingAdvice) {
                return;
            }

            const btn = document.getElementById('get-advice-btn');
            const message = document.getElementById('message');
            const recommendationsSection = document.getElementById('recommendations-section');
            const recommendationsContent = document.getElementById('recommendations-content');
            const nextStrategySection = document.getElementById('next-strategy-section');

            if (!btn || !recommendationsSection || !recommendationsContent || !nextStrategySection) {
                console.error('Get Advice elements not found');
                return;
            }

            isFetchingAdvice = true;
            btn.disabled = true;
            message.className = 'message';
            
            // Show loading state
            recommendationsSection.style.display = 'block';
            recommendationsContent.innerHTML = '<div class="loading">Getting recommendations...</div>';
            nextStrategySection.style.display = 'block';
            nextStrategySection.style.visibility = 'visible';
            nextStrategySection.innerHTML = '<h2>Next Action</h2><div class="loading">Getting next action...</div>';

            try {
                // Fetch options first
                const optionsRes = await fetch(`${API_URL}/advice/options`);
                
                if (!optionsRes.ok) {
                    throw new Error('Failed to get options');
                }

                const optionsData = await optionsRes.json();
                
                // Set default selectedPathId to recommended_id
                if (selectedPathId === null && optionsData.recommended_id) {
                    selectedPathId = optionsData.recommended_id;
                }
                
                // Fetch next action with selected path
                const nextUrl = selectedPathId 
                    ? `${API_URL}/advice/next?path_id=${encodeURIComponent(selectedPathId)}`
                    : `${API_URL}/advice/next`;
                const nextRes = await fetch(nextUrl);
                
                if (!nextRes.ok) {
                    throw new Error('Failed to get next action');
                }
                
                const nextData = await nextRes.json();
                
                console.log("advice_options", optionsData);
                console.log("advice_next", nextData);
                
                // Render options (3 cards) with selected state
                displayOptions(optionsData);
                
                // Render next action
                advice = nextData;
                setAdvice(nextData);
                
                message.className = 'message show';
                message.textContent = 'Advice loaded successfully!';
            } catch (error) {
                console.error('Failed to get advice:', error);
                if (recommendationsSection) {
                    recommendationsSection.style.display = 'block';
                    recommendationsContent.innerHTML = '<p class="placeholder">Failed to load options. Please try again.</p>';
                }
                if (nextStrategySection) {
                    nextStrategySection.style.display = 'block';
                    nextStrategySection.style.visibility = 'visible';
                    nextStrategySection.innerHTML = '<h2>Next Action</h2><div><p class="placeholder">Failed to load next action. Please try again.</p></div>';
                }
                message.className = 'message error show';
                message.textContent = 'Error loading advice';
            } finally {
                btn.disabled = false;
                isFetchingAdvice = false;
            }
        }

        function setAdvice(data) {
            // Normalize API data: ensure bullets is always an array
            if (data) {
                if (data.primary && (data.primary.bullets === null || data.primary.bullets === undefined)) {
                    data.primary.bullets = [];
                }
                if (data.why && (data.why.bullets === null || data.why.bullets === undefined)) {
                    data.why.bullets = [];
                }
                if (data.prep && (data.prep.bullets === null || data.prep.bullets === undefined)) {
                    data.prep.bullets = [];
                }
            }
            advice = data;
            renderAdvice();
        }

        function renderAdvice() {
            console.log("renderAdvice()", advice);
            
            const container = document.getElementById('next-strategy-section');
            
            if (!container) {
                console.error('Advice container element not found');
                return;
            }

            // Make sure container is visible
            container.style.display = 'block';
            container.style.visibility = 'visible';

            // Ensure at least primary card exists
            if (!advice || !advice.primary || !advice.primary.title) {
                container.innerHTML = '<h2>Next Action</h2><div><p class="placeholder">No advice available</p></div>';
                return;
            }

            // Helper to safely get bullets array (normalized, always returns array)
            const getBullets = (card) => {
                if (!card) return [];
                if (card.bullets === null || card.bullets === undefined) return [];
                return Array.isArray(card.bullets) ? card.bullets : [];
            };

            // Helper to safely get do_this_next (treat null/undefined as '')
            const getDoThisNext = (card) => {
                if (!card) return '';
                return card.do_this_next || '';
            };

            // Render card helper - safely handles missing/null fields
            const renderCard = (card, isPrimary = false) => {
                if (!card || !card.title) return '';
                
                const title = card.title || '';
                const doThisNext = getDoThisNext(card);
                const bullets = getBullets(card);
                const alternates = card.alternates || [];
                
                const borderColor = isPrimary ? '#4a5568' : '#cbd5e0';
                const titleColor = isPrimary ? '#2d3748' : '#4a5568';
                const titleSize = isPrimary ? '1.1rem' : '1rem';
                
                const doThisNextHtml = doThisNext 
                    ? `<p style="margin: 0; color: #333; line-height: 1.5; font-weight: 500;">Do this next: ${doThisNext}</p>`
                    : '';
                
                const bulletsHtml = bullets.length > 0
                    ? `<ul style="margin: 8px 0; margin-left: 20px; padding: 0; list-style: disc;">${bullets.map(b => `<li style="margin: 4px 0; color: #555;">${b}</li>`).join('')}</ul>`
                    : '';
                
                // Render alternates (only for primary card)
                const alternatesHtml = (isPrimary && alternates.length > 0)
                    ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                        <div style="font-size: 0.85rem; color: #718096; margin-bottom: 8px; font-weight: 600;">Alternate spots:</div>
                        <ul style="margin: 0; padding-left: 20px; list-style: disc;">
                            ${alternates.map(alt => {
                                const tagsHtml = alt.tags && alt.tags.length > 0
                                    ? ` <span style="display: inline-flex; gap: 4px; margin-left: 6px;">${alt.tags.map(tag => `<span style="background: #e2e8f0; color: #4a5568; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem;">${tag}</span>`).join('')}</span>`
                                    : '';
                                const reqHtml = alt.requirements
                                    ? ` <span style="color: #a0aec0; font-size: 0.75rem;">(${alt.requirements})</span>`
                                    : '';
                                return `<li style="margin: 4px 0; color: #555; line-height: 1.4;">
                                    <strong>${alt.name}</strong>: ${alt.reason}${reqHtml}${tagsHtml}
                                </li>`;
                            }).join('')}
                        </ul>
                       </div>`
                    : '';
                
                const hasContent = doThisNext || bullets.length > 0 || alternatesHtml;
                const marginBottom = hasContent ? '10px' : '0';
                
                return `
                    <div class="strategy-card" style="background: #f7fafc; border: ${isPrimary ? '2px' : '1px'} solid ${borderColor}; border-radius: 6px; padding: 16px;">
                        <h${isPrimary ? '3' : '4'} style="color: ${titleColor}; margin: 0 0 ${marginBottom} 0; font-size: ${titleSize}; font-weight: 600;">${title}</h${isPrimary ? '3' : '4'}>
                        ${doThisNextHtml}
                        ${bulletsHtml}
                        ${alternatesHtml}
                    </div>
                `;
            };

            // Safely render cards - skip missing sections
            const prepCard = advice.prep ? renderCard(advice.prep) : '';
            const primaryCard = renderCard(advice.primary, true); // Always render primary
            const whyCard = advice.why ? renderCard(advice.why) : '';

            // Render cards in order: Prep, Primary, Why (filter out empty strings)
            const cards = [prepCard, primaryCard, whyCard].filter(card => card !== '');
            
            container.innerHTML = `
                <h2>Next Action</h2>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${cards.join('')}
                </div>
            `;
        }

        function displayBeginnerPath() {
            const content = document.getElementById('advice-content');
            const adviceSection = document.getElementById('advice-display-section');
            
            if (!beginnerCards || beginnerCards.length === 0) {
                adviceSection.style.display = 'none';
                return;
            }

            // Show section when there's content
            adviceSection.style.display = 'block';
            
            const card = beginnerCards[currentCardIndex];
            const isFirst = currentCardIndex === 0;
            const isLast = currentCardIndex === beginnerCards.length - 1;
            
            content.innerHTML = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4a5568;">
                    <strong>Do steps in order unless marked Optional</strong>
                </div>
                <div class="beginner-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #2d3748;">${card.title}</h3>
                        ${card.optional ? '<span style="background: #718096; color: white; padding: 6px 14px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; min-width: 60px; text-align: center;">Optional</span>' : '<span style="background: #4a5568; color: white; padding: 6px 14px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; min-width: 60px; text-align: center;">Required</span>'}
                    </div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong style="color: #555;">Why:</strong>
                        <p style="margin-top: 8px; color: #333; line-height: 1.6;">${card.why_now}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #555;">Action:</strong>
                        <p style="margin-top: 8px; color: #333; line-height: 1.6;">${card.action}</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #555;">Unlocks:</strong>
                        <p style="margin-top: 8px; color: #333; line-height: 1.6;">${card.next_unlock}</p>
                    </div>
                    ${card.details ? `
                        <details style="margin-bottom: 15px;">
                            <summary style="cursor: pointer; color: #4a5568; font-weight: 600; padding: 10px; background: #f7fafc; border-radius: 6px; user-select: none;">
                                Details (click to expand)
                            </summary>
                            <div style="padding: 15px; background: #f7fafc; border-radius: 6px; margin-top: 10px; color: #333; line-height: 1.6;">
                                ${card.details}
                            </div>
                        </details>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                        <button 
                            onclick="previousCard()" 
                            ${isFirst ? 'disabled' : ''}
                            style="padding: 10px 20px; background: ${isFirst ? '#ccc' : '#4a5568'}; color: white; border: none; border-radius: 6px; cursor: ${isFirst ? 'not-allowed' : 'pointer'}; font-weight: 600; flex: 1; height: 40px; min-height: 40px;"
                        >
                            ← Back
                        </button>
                        <div style="flex: 1; text-align: center; padding: 10px; color: #666; font-size: 0.9rem;">
                            ${currentCardIndex + 1} / ${beginnerCards.length}
                        </div>
                        <button 
                            onclick="nextCard()" 
                            ${isLast ? 'disabled' : ''}
                            style="padding: 10px 20px; background: ${isLast ? '#ccc' : '#4a5568'}; color: white; border: none; border-radius: 6px; cursor: ${isLast ? 'not-allowed' : 'pointer'}; font-weight: 600; flex: 1; height: 40px; min-height: 40px;"
                        >
                            Next →
                        </button>
                    </div>
                </div>
            `;
        }

        function nextCard() {
            if (currentCardIndex < beginnerCards.length - 1) {
                currentCardIndex++;
                displayBeginnerPath();
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                displayBeginnerPath();
            }
        }

        async function selectPath(pathId) {
            selectedPathId = pathId;
            
            // Update visual highlight
            const cards = document.querySelectorAll('.advice-card');
            cards.forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-path-id="${pathId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Fetch and render next action
            try {
                const nextRes = await fetch(`${API_URL}/advice/next?path_id=${encodeURIComponent(pathId)}`);
                if (!nextRes.ok) {
                    throw new Error('Failed to get next action');
                }
                const nextData = await nextRes.json();
                advice = nextData;
                setAdvice(nextData);
            } catch (error) {
                console.error('Failed to fetch next action:', error);
            }
        }

        function displayOptions(optionsData) {
            const content = document.getElementById('recommendations-content');
            const section = document.getElementById('recommendations-section');
            
            if (!content || !section) {
                console.error('Recommendations elements not found');
                return;
            }
            
            if (!optionsData || !optionsData.options || optionsData.options.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Show section when there's content
            section.style.display = 'block';
            
            const recommendedId = optionsData.recommended_id || '';
            
            const cards = optionsData.options.map(option => {
                const isRecommended = option.id === recommendedId;
                // Only select if selectedPathId matches (don't fall back to recommendedId)
                const isSelected = selectedPathId !== null && option.id === selectedPathId;
                const tagsHtml = option.tags && option.tags.length > 0
                    ? `<div style="margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap;">
                        ${option.tags.map(tag => `<span style="background: #e2e8f0; color: #4a5568; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">${tag}</span>`).join('')}
                       </div>`
                    : '';
                
                const whyBulletsHtml = option.why_bullets && option.why_bullets.length > 0
                    ? `<ul style="margin: 10px 0; margin-left: 20px; padding: 0; list-style: disc;">
                        ${option.why_bullets.map(bullet => `<li style="margin: 4px 0; color: #555;">${bullet}</li>`).join('')}
                       </ul>`
                    : '';
                
                const cursorStyle = 'cursor: pointer;';
                
                return `
                    <div class="advice-card${isSelected ? ' selected' : ''}" 
                         data-path-id="${option.id}"
                         onclick="selectPath('${option.id}')"
                         style="background: #f7fafc; border: 1px solid #cbd5e0; border-radius: 8px; padding: 20px; ${cursorStyle} transition: all 0.2s;">
                        ${isRecommended ? '<div style="background: #4a5568; color: white; padding: 6px 14px; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-block; margin-bottom: 12px; min-width: 60px; text-align: center;">Recommended</div>' : ''}
                        <h3 style="color: #333; margin: ${isRecommended ? '8px' : '0'} 0 10px 0; font-size: 1.2rem; font-weight: 600;">${option.title}</h3>
                        <p style="color: #4a5568; margin: 0 0 12px 0; line-height: 1.5;">${option.summary}</p>
                        <div style="background: white; padding: 12px; border-left: 3px solid #4a5568; border-radius: 4px; margin: 12px 0;">
                            <strong style="color: #333; display: block; margin-bottom: 6px;">Do this next:</strong>
                            <p style="margin: 0; color: #555; line-height: 1.5;">${option.do_this_next}</p>
                        </div>
                        ${whyBulletsHtml}
                        ${tagsHtml}
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `<div class="advice-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">${cards}</div>`;
        }

        function displayRecommendations(items) {
            const content = document.getElementById('recommendations-content');
            const section = document.getElementById('recommendations-section');
            
            if (!content || !section) {
                console.error('Recommendations elements not found');
                return;
            }
            
            if (!items || items.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Show section when there's content
            section.style.display = 'block';

            const cards = items.map(item => {
                // Check if this is a loadout recommendation
                const isLoadout = item.title && item.title.toLowerCase().includes('loadout');
                
                // Process steps to add Details links for key items and food
                const processedSteps = item.steps.map(step => {
                    let processedStep = step;
                    
                    // Add Details link for food mentions
                    const foodMatch = step.match(/Bring food: (Lobsters|Swordfish|Sharks)/i);
                    if (foodMatch) {
                        const foodName = foodMatch[1];
                        // Replace the food name and any trailing text with a clickable link
                        processedStep = step.replace(
                            /Bring food: (Lobsters|Swordfish|Sharks)(.*?)/i,
                            (match, food, rest) => {
                                return `Bring food: <span class="details-link" onclick="showDetails('food', '${food}')">${food} (Details)</span>`;
                            }
                        );
                    }
                    
                    // For loadout recommendations, add Details links for key items
                    if (isLoadout) {
                        // Extract item names from steps (format: "Item Name: acquisition method")
                        const itemMatch = step.match(/^([^:]+):/);
                        if (itemMatch) {
                            const itemName = itemMatch[1].trim();
                            // Only add for key items (weapon, gloves, cape, ring, offhand)
                            const keyItems = ['Dragon Scimitar', 'Abyssal Whip', 'Tentacle Whip', 'Dharok\'s Greataxe', 
                                             'Dragon Defender', 'Barrows Gloves', 'Fire Cape', 'Berserker Ring', 
                                             'Combat Bracelet', 'Amulet of Fury', 'Amulet of Torture'];
                            if (keyItems.some(key => itemName.includes(key))) {
                                processedStep = step.replace(
                                    /^([^:]+):/,
                                    `$1 <span class="details-link" onclick="showDetails('item', '${itemName}')">(Details)</span>:`
                                );
                            }
                        }
                    }
                    
                    return processedStep;
                });
                
                // Process steps for display
                const processedStepsForDisplay = processedSteps;
                
                return `
                    <div class="advice-card">
                        <h3>${item.title}</h3>
                        <p class="why-now">
                            <strong>Why now:</strong> ${item.why_now}
                        </p>
                        <div class="steps">
                            <strong>Steps:</strong>
                            <ol>
                                ${processedStepsForDisplay.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                        ${item.why_over_alternatives ? `
                            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; color: #666; font-size: 0.9rem;">
                                <strong>Why this over alternatives:</strong> ${item.why_over_alternatives}
                            </p>
                        ` : ''}
                    </div>
                `;
            }).join('');

            content.innerHTML = `<div class="advice-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">${cards}</div>`;
        }

        function displayAdvice(items) {
            // Alias for displayRecommendations to maintain compatibility
            displayRecommendations(items);
        }

        function displayStrategies(strategies) {
            const content = document.getElementById('advice-content');
            const titleElement = document.getElementById('advice-section-title');
            const adviceSection = document.getElementById('advice-display-section');

            if (!strategies || strategies.length === 0) {
                if (adviceSection) {
                    adviceSection.style.display = 'none';
                }
                return;
            }

            // Show section when there's content
            if (adviceSection) {
                adviceSection.style.display = 'block';
            }
            if (titleElement) {
                titleElement.textContent = 'Strategies';
            }

            const cards = strategies.map(strategy => {
                const unlockPathBtn = strategy.unlock_path_context ? 
                    `<button class="strategy-btn" onclick="viewUnlockPath('${strategy.unlock_path_context}')">View Unlock Path</button>` : '';
                
                const buildBtn = strategy.build_context ? 
                    `<button class="strategy-btn" onclick="viewBuild('${strategy.build_context}')">View Recommended Build</button>` : '';

                return `
                    <div class="strategy-card">
                        <h3>${strategy.title}</h3>
                        <div class="strategy-why">
                            <strong>Why this matters:</strong> ${strategy.why}
                        </div>
                        <div class="strategy-unlocks">
                            <h4>What this unlocks:</h4>
                            <ul>
                                ${strategy.unlocks.map(unlock => `<li>${unlock}</li>`).join('')}
                            </ul>
                        </div>
                        ${strategy.next_actions && strategy.next_actions.length > 0 ? `
                            <div class="strategy-actions">
                                <h4>Next actions:</h4>
                                <ul>
                                    ${strategy.next_actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="strategy-buttons">
                            ${unlockPathBtn}
                            ${buildBtn}
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `<div class="advice-cards">${cards}</div>`;
        }

        function viewUnlockPath(context) {
            // For now, show builds filtered by context
            // In future, this could show a detailed unlock path
            viewBuilds(context);
        }

        function viewBuild(context) {
            // Show builds section and filter by context
            const buildsSection = document.getElementById('builds-section');
            const contextSelect = document.getElementById('build-context');
            
            if (contextSelect) {
                contextSelect.value = context;
            }
            
            buildsSection.style.display = 'block';
            buildsSection.scrollIntoView({ behavior: 'smooth' });
            viewBuilds();
        }

        async function showDetails(type, name) {
            const modal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSteps = document.getElementById('modal-steps');
            const modalSources = document.getElementById('modal-sources');
            
            // Show modal
            modal.style.display = 'block';
            modalTitle.textContent = `Loading...`;
            modalSteps.innerHTML = '';
            modalSources.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/details?type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to load details');
                }
                
                const data = await response.json();
                
                modalTitle.textContent = data.title;
                
                // Display steps
                if (data.steps && data.steps.length > 0) {
                    modalSteps.innerHTML = `
                        <h3>Steps</h3>
                        <ol>
                            ${data.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    `;
                }
                
                // Display sources
                if (data.sources && data.sources.length > 0) {
                    modalSources.innerHTML = `
                        <h3>Sources</h3>
                        <ul>
                            ${data.sources.map(source => `<li>${source}</li>`).join('')}
                        </ul>
                    `;
                }
            } catch (error) {
                console.error('Failed to load details:', error);
                modalTitle.textContent = 'Error';
                modalSteps.innerHTML = `<p style="color: #e74c3c;">Failed to load details: ${error.message}</p>`;
            }
        }

        // Close modal when clicking outside or on close button
        window.onclick = function(event) {
            const modal = document.getElementById('details-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        async function viewBuilds() {
            const buildsSection = document.getElementById('builds-section');
            const buildsContent = document.getElementById('builds-content');
            const contextSelect = document.getElementById('build-context');
            const context = contextSelect.value;

            buildsSection.style.display = 'block';
            buildsContent.innerHTML = '<div class="loading">Loading builds...</div>';

            try {
                const url = context ? `${API_URL}/builds?context=${encodeURIComponent(context)}` : `${API_URL}/builds`;
                const response = await fetch(url);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to load builds');
                }

                const data = await response.json();
                displayBuilds(data.builds);
            } catch (error) {
                console.error('Failed to load builds:', error);
                buildsContent.innerHTML = '<p class="placeholder">Failed to load builds. Please try again.</p>';
            }
        }

        function displayBuilds(builds) {
            const content = document.getElementById('builds-content');

            if (!builds || builds.length === 0) {
                content.innerHTML = '<p class="placeholder">No builds found for selected context</p>';
                return;
            }

            const cards = builds.map((build, index) => {
                const selectedId = build.default_gear_option_id || (build.gear_options && build.gear_options[0]?.id) || 'progression';
                const selected = (build.gear_options || []).find(o => o.id === selectedId) || (build.gear_options || [])[0];
                const gear = (selected && selected.gear) || [];
                const gearOptions = build.gear_options || [];

                return `
                <div class="build-card" data-build-index="${index}">
                    <h3>${build.name}</h3>
                    <div class="build-section">
                        <strong>Gear:</strong>
                        <div class="gear-options" style="margin: 8px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                            ${gearOptions.map(opt => `
                                <button class="gear-option-pill ${opt.id === selectedId ? 'active' : ''}" 
                                        onclick="selectGearOption(${index}, '${opt.id}')"
                                        data-option-id="${opt.id}">
                                    ${opt.id}
                                </button>
                            `).join('')}
                        </div>
                        <div id="gear-debug-${index}" style="margin: 8px 0; padding: 8px; background: #edf2f7; border-radius: 4px; font-size: 0.9rem;">
                            Selected tier: ${selectedId}<br>
                            Weapon: ${gear.length > 0 ? gear[0] : 'None'}
                        </div>
                        <ul id="gear-list-${index}">
                            ${gear.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="build-section">
                        <strong>Inventory:</strong>
                        <ul>
                            ${(build.inventory || []).map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="build-section">
                        <strong>Prayers:</strong>
                        <ul>
                            ${(build.prayers || []).map(prayer => `<li>${prayer}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="build-section">
                        <strong>Notes:</strong>
                        <ul>
                            ${(build.notes || []).map(note => `<li>${note}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            }).join('');

            // Store build data for gear option switching
            if (!window.buildsData) {
                window.buildsData = {};
            }
            builds.forEach((build, index) => {
                window.buildsData[index] = build;
            });

            content.innerHTML = cards;
        }

        function selectGearOption(buildIndex, optionId) {
            const build = window.buildsData && window.buildsData[buildIndex];
            if (!build || !build.gear_options) return;

            const selected = build.gear_options.find(o => o.id === optionId);
            if (!selected) return;

            const gear = selected.gear || [];

            // Update gear list
            const gearList = document.getElementById(`gear-list-${buildIndex}`);
            if (gearList) {
                gearList.innerHTML = gear.map(item => `<li>${item}</li>`).join('');
            }

            // Update debug header
            const debugHeader = document.getElementById(`gear-debug-${buildIndex}`);
            if (debugHeader) {
                debugHeader.innerHTML = `Selected tier: ${optionId}<br>Weapon: ${gear.length > 0 ? gear[0] : 'None'}`;
            }

            // Update active pill
            const buildCard = document.querySelector(`[data-build-index="${buildIndex}"]`);
            if (buildCard) {
                buildCard.querySelectorAll('.gear-option-pill').forEach(pill => {
                    if (pill.dataset.optionId === optionId) {
                        pill.classList.add('active');
                    } else {
                        pill.classList.remove('active');
                    }
                });
            }
        }
    </script>

    <!-- Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-steps" class="modal-steps"></div>
            <div id="modal-sources" class="modal-sources"></div>
        </div>
    </div>
</body>
</html>

